<!doctype html>

<meta charset="utf-8">
<title>Dagre D3 Demo: Shapes</title>

<link rel="stylesheet" href="demo.css">
<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
<script src="../dist/dagre-d3.js"></script>

<style id="css">
body {
  font: 300 14px 'Helvetica Neue', Helvetica;
}

.node rect,
.node circle,
.node ellipse,
.node polygon {
  stroke: #333;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path {
  stroke: #333;
  fill: #333;
  stroke-width: 1.5px;
}
</style>

<h1>Dagre D3 Demo: Shapes</h1>

<svg width=960 height=600><g/></svg>

<section>
<p>A sample that shows the different node shapes available in dagre-d3.
</section>

<script id="js">
// Create a new directed graph
var g = new dagreD3.graphlib.Graph().setGraph({});

const nodes = [
  // COMMITS
  {
    "id": "5a6e4d2923db9c7518ce27038fc42f8fdf040c5d",
    "shortId": "5a6e4d2",
    "type": "commit",
    "content": "tree 94f303f0933f23451a62642c4d5b28aabbb8d8a2\\nparent 3dd8f2f8ae9ed1801d2a776cc73748f39f822902\\nauthor G Roques <groques360@gmail.com> 1736308279 -0600\\ncommitter G Roques <groques360@gmail.com> 1736308279 -0600\\n\\nC4\\n",
    "rank": 0
  },
  {
    "id": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902",
    "shortId": "3dd8f2f",
    "type": "commit",
    "content": "tree 757993103645c74706e5597e9d226bb61ef487f5\\nparent 850c1aa0f1ce5d081f376571c5d22c09d2ffa40a\\nauthor G Roques <groques360@gmail.com> 1736308156 -0600\\ncommitter G Roques <groques360@gmail.com> 1736308156 -0600\\n\\nC3\\n",
    "rank": 0
  },
  {
    "id": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40a",
    "shortId": "850c1aa",
    "type": "commit",
    "content": "tree a5dd047c19f89e5d9a6bb04f3914ab47a7664e7d\\nparent 9cd6eec36f90f1cde45d345fec57276f9cafe936\\nauthor G Roques <groques360@gmail.com> 1736308122 -0600\\ncommitter G Roques <groques360@gmail.com> 1736308122 -0600\\n\\nC2\\n",
    "rank": 0
  },
  {
    "id": "9cd6eec36f90f1cde45d345fec57276f9cafe936",
    "shortId": "9cd6eec",
    "type": "commit",
    "content": "tree 95025e2d19dbb6e934a82809be657d454b6c6c5c\\nauthor G Roques <groques360@gmail.com> 1736308107 -0600\\ncommitter G Roques <groques360@gmail.com> 1736308107 -0600\\n\\nC1\\n",
    "rank": 0
  },
  {
    "id": "95025e2d19dbb6e934a82809be657d454b6c6c5c",
    "shortId": "95025e2",
    "type": "tree",
    "content": "100644 blob 0f6a4e6354e536514412ba38ab50ad6264a4d323\\t1.txt\\n",
    "rank": 2
  },
  {
    "id": "0f6a4e6354e536514412ba38ab50ad6264a4d323",
    "shortId": "0f6a4e6",
    "type": "blob",
    "content": "one text\\n",
    "rank": 4
  },
  {
    "id": "a5dd047c19f89e5d9a6bb04f3914ab47a7664e7d",
    "shortId": "a5dd047",
    "type": "tree",
    "content": "100644 blob 5ddb8fbbb5f08e9a519c9ca2627b62769148717f\\t1.txt\\n",
    "rank": 2
  },
  {
    "id": "5ddb8fbbb5f08e9a519c9ca2627b62769148717f",
    "shortId": "5ddb8fb",
    "type": "blob",
    "content": "one text\\na change\\n",
    "rank": 4
  },
  {
    "id": "757993103645c74706e5597e9d226bb61ef487f5",
    "shortId": "7579931",
    "type": "tree",
    "content": "100644 blob 5ddb8fbbb5f08e9a519c9ca2627b62769148717f\\t1.txt\\n040000 tree ceb3233dbcd0400dc830446c7f60b83f92561573\\tdir\\n",
    "rank": 2
  },
  {
    "id": "ceb3233dbcd0400dc830446c7f60b83f92561573",
    "shortId": "ceb3233",
    "type": "tree",
    "content": "100644 blob ae9195ccccc4d9230937c2ec2b9b717e7d7c0e02\\t2.txt\\n",
    "rank": 4
  },
  {
    "id": "ae9195ccccc4d9230937c2ec2b9b717e7d7c0e02",
    "shortId": "ae9195c",
    "type": "blob",
    "content": "two text\\n",
    "rank": 6
  },
  {
    "id": "94f303f0933f23451a62642c4d5b28aabbb8d8a2",
    "shortId": "94f303f",
    "type": "tree",
    "content": "100644 blob 5ddb8fbbb5f08e9a519c9ca2627b62769148717f\\t1.txt\\n100644 blob 0f6a4e6354e536514412ba38ab50ad6264a4d323\\t3.txt\\n040000 tree ceb3233dbcd0400dc830446c7f60b83f92561573\\tdir\\n",
    "rank": 2
  },
  // {
  //   "id": "4319c060d301120c32a1693ec5f89fa4c5071567",
  //   "shortId": "4319c06",
  //   "type": "blob",
  //   "content": "one a text\\n",
  //   "rank": 6
  // },
];
const edges = [
  // INTER COMMIT EDGES
  // {
  //   "id": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902850c1aa0f1ce5d081f376571c5d22c09d2ffa40a",
  //   "source": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902",
  //   "target": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40a"
  // },
  // {
  //   "id": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40a9cd6eec36f90f1cde45d345fec57276f9cafe936",
  //   "source": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40a",
  //   "target": "9cd6eec36f90f1cde45d345fec57276f9cafe936"
  // },
  // {
  //   "id": "5a6e4d2923db9c7518ce27038fc42f8fdf040c5d3dd8f2f8ae9ed1801d2a776cc73748f39f822902",
  //   "source": "5a6e4d2923db9c7518ce27038fc42f8fdf040c5d",
  //   "target": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902"
  // },
  // COMMIT TO ROOT TREE EDGES
  {
    "id": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902757993103645c74706e5597e9d226bb61ef487f5",
    "source": "3dd8f2f8ae9ed1801d2a776cc73748f39f822902",
    "target": "757993103645c74706e5597e9d226bb61ef487f5"
  },
  {
    "id": "9cd6eec36f90f1cde45d345fec57276f9cafe93695025e2d19dbb6e934a82809be657d454b6c6c5c",
    "source": "9cd6eec36f90f1cde45d345fec57276f9cafe936",
    "target": "95025e2d19dbb6e934a82809be657d454b6c6c5c"
  },
  {
    "id": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40aa5dd047c19f89e5d9a6bb04f3914ab47a7664e7d",
    "source": "850c1aa0f1ce5d081f376571c5d22c09d2ffa40a",
    "target": "a5dd047c19f89e5d9a6bb04f3914ab47a7664e7d"
  },
  {
    "id": "5a6e4d2923db9c7518ce27038fc42f8fdf040c5d94f303f0933f23451a62642c4d5b28aabbb8d8a2",
    "source": "5a6e4d2923db9c7518ce27038fc42f8fdf040c5d",
    "target": "94f303f0933f23451a62642c4d5b28aabbb8d8a2"
  },
  // ROOT TREE EDGES
  {
    "id": "95025e2d19dbb6e934a82809be657d454b6c6c5c0f6a4e6354e536514412ba38ab50ad6264a4d323",
    "source": "95025e2d19dbb6e934a82809be657d454b6c6c5c",
    "target": "0f6a4e6354e536514412ba38ab50ad6264a4d323",
    "label": "1.txt",
  },
  // {
  //   "source": "95025e2d19dbb6e934a82809be657d454b6c6c5c",
  //   "target": "4319c060d301120c32a1693ec5f89fa4c5071567",
  //   "label": "1a.txt"
  // },
  {
    "id": "a5dd047c19f89e5d9a6bb04f3914ab47a7664e7d5ddb8fbbb5f08e9a519c9ca2627b62769148717f",
    "source": "a5dd047c19f89e5d9a6bb04f3914ab47a7664e7d",
    "target": "5ddb8fbbb5f08e9a519c9ca2627b62769148717f",
    "label": "1.txt",
  },
  {
    "id": "757993103645c74706e5597e9d226bb61ef487f5ceb3233dbcd0400dc830446c7f60b83f92561573",
    "source": "757993103645c74706e5597e9d226bb61ef487f5",
    "target": "ceb3233dbcd0400dc830446c7f60b83f92561573",
    "label": "dir",
  },
  {
    "id": "ceb3233dbcd0400dc830446c7f60b83f92561573ae9195ccccc4d9230937c2ec2b9b717e7d7c0e02",
    "source": "ceb3233dbcd0400dc830446c7f60b83f92561573",
    "target": "ae9195ccccc4d9230937c2ec2b9b717e7d7c0e02",
    "label": "2.txt",
  },
];


function nodePropertiesByType(type) {
  if (type === "commit") {
    return {shape: 'circle', style: 'fill: green; stroke: darkgreen'};
  } else if (type === "tree") {
    return {shape: 'rect', style: 'fill: blue; stroke: darkblue'};
  } else if (type === "blob") {
    return {shape: 'rect', style: 'fill: red; stroke: darkred'};
  } else {
    throw new Error(`Unexpected type "${type}"`);
  }
}

nodes.forEach(node => {
  const typeSpecificProperties = nodePropertiesByType(node.type);
  g.setNode(node.id, {
    label: node.shortId,
    labelStyle: 'fill: white; font-weight: bold',
    rank: node.rank,
    ...typeSpecificProperties
  });
});

edges.forEach(edge => {
  g.setEdge(edge.source, edge.target, {label: edge.label, labelpos: 'r'});
});

var svg = d3.select("svg"),
    inner = svg.select("g");

// Set up zoom support
var zoom = d3.zoom().on("zoom", function() {
      inner.attr("transform", d3.event.transform);
    });
svg.call(zoom);

// Create the renderer
var render = new dagreD3.render();

// Custom triangle
render.shapes().triangle = function(parent, bbox, node) {
  var w = bbox.width,
      h = bbox.height,
      points = [
        { x: 0, y: h },
        { x: w, y: h },
        { x: w/2, y: (Math.sqrt(3) / 2) * -h }
      ];
      shapeSvg = parent.insert("polygon", ":first-child")
        .attr("points", points.map(function(d) { return d.x + "," + d.y; }).join(" "))
        .attr("transform", "translate(" + (-w/2) + "," + (h * Math.sqrt(3)/4) + ")");
  console.log({w, h})

  node.intersect = function(point) {
    return dagreD3.intersect.polygon(node, points, point);
  };

  return shapeSvg;
};

// Run the renderer. This is what draws the final graph.
render(inner, g);

// Center the graph
var initialScale = 0.75;
svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 2, 20).scale(initialScale));

svg.attr('height', g.graph().height * initialScale + 40);
</script>

<script src="demo.js"></script>
